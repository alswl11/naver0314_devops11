<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&family=Black+Han+Sans&family=Bungee+Spice&family=Diphylleia&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Nanum+Pen+Script&family=Song+Myung&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <style>
        body * {
            font-family: "Song Myung";
        }
        div.guestlist div.box {
            width: 400px;
            padding: 10px;
            border : 1px solid gray;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        div.guestlist div.box img{
            width: 50px;
            margin-right: 5px;
        }
        div.guestlist div.box a {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <script type="text/javascript">
        $(function(){
            list();//처음 로딩시 일단 목록 출력

            //db저장 버튼 이벤트
            $("#btnsave").click(function(){
                //입력체크
                let avata=$("#selavata").val();
                let nickname=$("#nickname").val();
                let content=$("#content").val();

                if(nickname.length==0){
                    alert("닉네임을 입력해주세요");
                    return;
                }
                if(content.length==0){
                    alert("내용을 입력해주세요");
                    return;
                }

                $.ajax({
                    type:"post",
                    dataType:"html",
                    url:"./data/insertdata.jsp",
                    //data:"avata="+avata+"&nickname="+nickname+"&content="+content,
                    data:{"avata":avata,"nickname":nickname,"content":content},
                    success:function(){
                        //데이타 추가 성공후 해야할일들
                        list();//목록 다시 출력
                        //입력값들 초기화
                        $("#selavata").val("../snoopyAvata/s1.JPG");
                        $(".avata").attr("src","../snoopyAvata/s1.JPG");
                        $("#nickname").val("");
                        $("#content").val("");
                    }
                });
            });
            // 검색버튼 이벤트
            $("#btnsearch").click(function (){
               list();
            });
            // 삭제 이벤트
            $(document).on("click", ".adel", function (e) {
                e.preventDefault(); // 기본 이벤트 무효화
                let num = $(this).attr("num");
                let a = confirm("삭제하시겠습니까?");
                if(a) {
                    $.ajax({
                        type : "get",
                        dataType : "html",
                        url : "./data/delete.jsp",
                        data : {"num":num},
                        success : function () {
                            list();
                        }
                    })
                }
            });
            // 수정 이벤트
            $(document).on("click",".amod",function(e){
                e.preventDefault();//기본 이벤트 무효화
                //num 가져오기
                let num=$(this).attr("num");
                //백엔드에서 num 에 대한 dto기져와야한다
                $.ajax({
                    type:"get",
                    dataType:"json",
                    data:{"num":num},
                    url:"./data/update.jsp",
                    success:function(data){
                        // alert(data.nickname);
                        $("#model-num").val(num);
                        $("#model-nickname").val(data.nickname);
                        $("#model-content").val(data.content);
                    }
                });
            });
            $("#model-btnsave").click(function () {
                let num = $("#model-num").val();
                let nickname = $("#model-nickname").val();
                let content = $("#model-content").val();
                $.ajax({
                    type:"post",
                    dataType:"html",
                    url:"./data/updateaction.jsp",
                    data: {"num": num, "nickname": nickname, "content": content},
                    success:function(){
                        list();
                        $("#myModalUpdate").modal("hide");
                        $("#model-nickname").val(nickname);
                        $("#model-content").val(content);
                    }
                });
            });
        }); // end func

        function list()
        {
            let search = $("#search").val();
            $("div.guestlist").empty();
            $.ajax({
                type:"get",
                dataType:"json",
                data : {"search" : search},
                url:"./data/listdata.jsp",
                success:function(data){
                    // 검색 단어 삭제
                    $("#search").val("");

                    let s="";
                    s=`총 ${data.length}개의 방명록 글이 있습니다<br>`;
                    $.each(data,function(idx,ele){
                        s+=
                            `
                            <div class="box">
                            <img src="${ele.avata}">
                            <b>${ele.nickname}</b>
                            <span style="float: right">
                            <a class="amod" num = "${ele.num}"
                            data-bs-toggle="modal" data-bs-target="#myModalUpdate">수정</a>
                            /
                            <a class="adel" num = "${ele.num}">삭제</a>
                            </span>
                            <br>
                            <span style="color: gray; font-size: 13px" >${ele.writeday}</span>
                            <br>
                            <pre>${ele.content}</pre>
                            </div>
                            `;
                    });
                    $("div.guestlist").html(s);
                }
            });
        }
    </script>
</head>
<body>
<!-- The Modal 수정시 호출되는 modal dialog-->
<div class="modal" id="myModalUpdate">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">방명록 닉네임/내용 수정</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <div class="input-group">
                    <input type="hidden" id="model-num">
                    <input type="text" id="model-nickname" class="form-control" >

                    <button type="button" class="btn btn-sm btn-success" id="model-btnsave">
                        DB수정</button>
                </div>
                <textarea id="model-content" style="width: 100%;height: 100px;"
                          placeholder="내용을 입력하세요"></textarea>
            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>
<div style="margin: 10px;width:400px;">
    <h5 class="alert alert-info">방명록</h5>
    <div class="inputform">
        <div class="input-group">
            <select class="form-select" id="selavata">
                <script>
                    for(let i=1;i<=10;i++){
                        document.write(`<option value="../snoopyAvata/s${i}.JPG">
				  아바타 #${i}</option>`);
                    }
                </script>
            </select>
            <img src="../snoopyAvata/s1.JPG" width="40" class="avata">
            <script>
                $("#selavata").change(function(){
                    $(".avata").attr("src",$(this).val());
                });
            </script>
            <input type="text" id="nickname" class="form-control"
                   placeholder="닉네임입력">

            <button type="button" class="btn btn-sm btn-success" id="btnsave">
                DB저장</button>
        </div>
        <textarea id="content" style="width: 100%;height: 100px;"
                  placeholder="내용을 입력하세요"></textarea>
        <hr>
        <div class="input-group" style="margin-left: 100px; width: 300px">
            <b>닉네임 검색</b>
            <input type="text" id="search" class="form-control" style="margin-left: 10px">
            <button type="button" class="btn btn-sm btn-info" id="btnsearch">검색</button>
        </div>
        <div class="guestlist">111</div>
    </div>
</div>
</body>
</html>